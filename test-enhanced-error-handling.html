<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Enhanced Error Handling - Agente Geográfico</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1>Test Enhanced Error Handling for Kit Recommendations</h1>
        
        <div class="test-section">
            <h2>Test Cases with Enhanced Error Display</h2>
            
            <button onclick="testErrorCodeWithDescription()">Test Error Code with Description</button>
            <button onclick="testLosViableFalse()">Test LOS Not Viable</button>
            <button onclick="testNoViableKits()">Test No Viable Kits</button>
            <button onclick="testGenericError()">Test Generic Error</button>
            <button onclick="testRetryFunctionality()">Test Retry Functionality</button>
        </div>
        
        <div id="recommendation-block" style="display: none;">
            <div class="recommendation-container">
                <div id="recommendation-loading" class="recommendation-loading">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <p>Generando recomendaciones de kits...</p>
                    </div>
                </div>
                
                <div id="recommendation-content" class="recommendation-content" style="display: none;">
                    <!-- Content will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Test data with enhanced error formats
        const errorCodeData = {
            "0": {
                "output": {
                    "error_code": "E001",
                    "error_explanation": "No se encontraron kits compatibles para la distancia especificada",
                    "los_viable": true,
                    "viable_kits": []
                }
            }
        };

        const losViableFalseData = {
            "0": {
                "output": {
                    "error_code": null,
                    "error_explanation": null,
                    "los_viable": false,
                    "viable_kits": []
                }
            }
        };

        const noViableKitsData = {
            "0": {
                "output": {
                    "error_code": null,
                    "error_explanation": null,
                    "los_viable": true,
                    "viable_kits": []
                }
            }
        };

        const genericErrorData = {
            "0": {
                "output": {
                    "error_code": "E999",
                    "error_explanation": "Error interno del servidor - intente nuevamente más tarde",
                    "los_viable": false,
                    "viable_kits": []
                }
            }
        };

        // Mock request data for retry functionality
        const mockRequestData = {
            selectedResultId: "SOP-00008",
            completeSopData: {
                SOP: "SOP-00008",
                Plaza: "Monterrey",
                distance_km: 0.775
            },
            bandwidth: "100 Mbps",
            AigentID: "AIG-20250712-200313-9RQS6"
        };

        // Enhanced error handling functions
        function extractKitRecommendationData(responseData) {
            console.log('Extracting kit recommendation data from:', responseData);
            
            let recommendationData = null;
            let errorMessage = null;
            
            // Check if response has "0" key with output property (new format)
            if (responseData["0"] && responseData["0"].output) {
                recommendationData = responseData["0"].output;
            }
            // Check if response has output property (direct format)
            else if (responseData.output) {
                recommendationData = responseData.output;
            }
            // Check if response is an array with output property (array format)
            else if (Array.isArray(responseData) && responseData.length > 0 && responseData[0].output) {
                recommendationData = responseData[0].output;
            }
            // Check if response has the structure directly
            else if (responseData.viable_kits || responseData.high_reliability_recommendation || responseData.best_value_recommendation) {
                recommendationData = responseData;
            }
            
            // If we found recommendation data, check for errors
            if (recommendationData) {
                // Check for error_code and error_explanation
                if (recommendationData.error_code && recommendationData.error_code !== null) {
                    errorMessage = `Error ${recommendationData.error_code}: ${recommendationData.error_explanation || 'Error desconocido'}`;
                }
                
                // Check for los_viable status
                if (recommendationData.los_viable === false) {
                    errorMessage = 'No hay línea de vista viable para esta ubicación.';
                }
                
                // Additional validation: check if we have viable kits
                if (!recommendationData.viable_kits || !Array.isArray(recommendationData.viable_kits) || recommendationData.viable_kits.length === 0) {
                    if (!errorMessage) {
                        errorMessage = 'No se encontraron kits viables para esta ubicación.';
                    }
                }
            }
            
            return {
                data: recommendationData,
                error: errorMessage
            };
        }

        function handleKitRecommendationError(errorMessage, section = 'recommendations', requestData = null) {
            console.error('Kit recommendation error:', errorMessage);
            
            // Show recommendation block but with error state
            const recommendationBlock = document.getElementById('recommendation-block');
            if (recommendationBlock) {
                recommendationBlock.style.display = 'block';
            }
            
            // Hide loading, show error content
            const recommendationLoading = document.getElementById('recommendation-loading');
            const recommendationContent = document.getElementById('recommendation-content');
            
            if (recommendationLoading) {
                recommendationLoading.style.display = 'none';
            }
            if (recommendationContent) {
                recommendationContent.style.display = 'block';
                
                // Enhanced error display with better formatting
                let errorDisplay = errorMessage;
                
                // Check if error message contains error code format (Error XXX: description)
                if (errorMessage.includes('Error ') && errorMessage.includes(':')) {
                    const parts = errorMessage.split(':');
                    const errorCode = parts[0].trim();
                    const errorDescription = parts.slice(1).join(':').trim();
                    
                    errorDisplay = `
                        <div class="error-code" style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem; color: #ff6b6b;">
                            ${errorCode}
                        </div>
                        <div class="error-description" style="font-size: 1rem; color: #ff6b6b; margin-bottom: 1.5rem;">
                            ${errorDescription}
                        </div>
                    `;
                } else {
                    errorDisplay = `<p style="margin-bottom: 1.5rem;">${errorMessage}</p>`;
                }
                
                recommendationContent.innerHTML = `
                    <div class="error-message" style="text-align: center; padding: 2rem; color: #ff6b6b; background: rgba(255, 107, 107, 0.1); border-radius: 8px; border: 1px solid rgba(255, 107, 107, 0.3);">
                        <h3 style="margin-bottom: 1rem; color: #ff6b6b;">Error en las Recomendaciones</h3>
                        ${errorDisplay}
                        <button id="retry_agent_response_kit" onclick="retryKitRecommendations()" style="
                            margin-top: 1rem; 
                            padding: 1rem 2rem; 
                            background: #ffffff; 
                            color: #000000; 
                            border: none; 
                            border-radius: 4px; 
                            cursor: pointer;
                            font-size: 1rem;
                            font-weight: 500;
                            text-transform: uppercase;
                            letter-spacing: 1px;
                            transition: all 0.3s ease;
                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                        ">
                            Reintentar
                        </button>
                    </div>
                `;
                
                // Add hover effects to the retry button
                const retryButton = document.getElementById('retry_agent_response_kit');
                if (retryButton) {
                    retryButton.onmouseover = function() {
                        this.style.background = '#f0f0f0';
                        this.style.transform = 'translateY(-2px)';
                        this.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.2)';
                    };
                    retryButton.onmouseout = function() {
                        this.style.background = '#ffffff';
                        this.style.transform = 'none';
                        this.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
                    };
                    retryButton.onmousedown = function() {
                        this.style.transform = 'translateY(0)';
                    };
                    retryButton.onmouseup = function() {
                        this.style.transform = 'translateY(-2px)';
                    };
                }
                
                // Store request data for retry functionality
                if (requestData) {
                    window.lastKitRequestData = requestData;
                }
            }
        }

        async function retryKitRecommendations() {
            console.log('Retrying kit recommendations...');
            
            // Get the stored request data
            const requestData = window.lastKitRequestData;
            if (!requestData) {
                alert('No hay datos de solicitud disponibles para reintentar');
                return;
            }
            
            // Disable retry button and show loading state
            const retryButton = document.getElementById('retry_agent_response_kit');
            if (retryButton) {
                retryButton.disabled = true;
                retryButton.textContent = 'Reintentando...';
                retryButton.style.opacity = '0.7';
                retryButton.style.cursor = 'not-allowed';
            }
            
            // Hide error content and show loading
            const recommendationContent = document.getElementById('recommendation-content');
            const recommendationLoading = document.getElementById('recommendation-loading');
            
            if (recommendationContent) {
                recommendationContent.style.display = 'none';
            }
            if (recommendationLoading) {
                recommendationLoading.style.display = 'flex';
            }
            
            // Simulate retry delay
            setTimeout(() => {
                // Simulate success on retry
                const successData = {
                    "0": {
                        "output": {
                            "viable_kits": [
                                {
                                    "name": "KIT 1",
                                    "radio": "Mimosa C5x",
                                    "antenna": "Antena Mimosa N5X25",
                                    "frequency_band": "4.9 - 6.4 GHz",
                                    "max_throughput": "700 Mbps",
                                    "transmit_power": "27 dBm",
                                    "antenna_gain": "25 dBi",
                                    "link_margin": "21.36 dB",
                                    "cost": "691 USD"
                                }
                            ],
                            "high_reliability_recommendation": "KIT 1",
                            "best_value_recommendation": "KIT 1",
                            "error_code": null,
                            "error_explanation": null,
                            "los_viable": true
                        }
                    }
                };
                
                // Hide loading
                if (recommendationLoading) {
                    recommendationLoading.style.display = 'none';
                }
                if (recommendationContent) {
                    recommendationContent.style.display = 'block';
                    recommendationContent.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #4CAF50;">
                            <h3 style="margin-bottom: 1rem; color: #4CAF50;">¡Reintento Exitoso!</h3>
                            <p style="margin-bottom: 1.5rem;">Se encontraron recomendaciones de kits después del reintento.</p>
                            <div style="background: rgba(76, 175, 80, 0.1); border-radius: 8px; padding: 1rem; margin: 1rem 0;">
                                <h4>KIT 1</h4>
                                <p><strong>Radio:</strong> Mimosa C5x</p>
                                <p><strong>Antena:</strong> Antena Mimosa N5X25</p>
                                <p><strong>Costo:</strong> 691 USD</p>
                            </div>
                        </div>
                    `;
                }
                
                // Reset retry button
                if (retryButton) {
                    retryButton.disabled = false;
                    retryButton.textContent = 'Reintentar';
                    retryButton.style.opacity = '1';
                    retryButton.style.cursor = 'pointer';
                }
                
                console.log('Retry successful!');
            }, 2000);
        }

        // Test functions
        function testErrorCodeWithDescription() {
            console.log('Testing error code with description...');
            const { data, error } = extractKitRecommendationData(errorCodeData);
            if (error) {
                handleKitRecommendationError(error, 'recommendations', mockRequestData);
            }
        }

        function testLosViableFalse() {
            console.log('Testing LOS not viable...');
            const { data, error } = extractKitRecommendationData(losViableFalseData);
            if (error) {
                handleKitRecommendationError(error, 'recommendations', mockRequestData);
            }
        }

        function testNoViableKits() {
            console.log('Testing no viable kits...');
            const { data, error } = extractKitRecommendationData(noViableKitsData);
            if (error) {
                handleKitRecommendationError(error, 'recommendations', mockRequestData);
            }
        }

        function testGenericError() {
            console.log('Testing generic error...');
            const { data, error } = extractKitRecommendationData(genericErrorData);
            if (error) {
                handleKitRecommendationError(error, 'recommendations', mockRequestData);
            }
        }

        function testRetryFunctionality() {
            console.log('Testing retry functionality...');
            // First show an error
            handleKitRecommendationError('Error E002: Problema temporal del servidor', 'recommendations', mockRequestData);
        }
    </script>
</body>
</html> 