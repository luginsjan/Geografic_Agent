<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Error Handling - Agente Geográfico</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1>Test Error Handling for Kit Recommendations</h1>
        
        <div class="test-section">
            <h2>Test Cases</h2>
            
            <button onclick="testSuccessCase()">Test Success Case</button>
            <button onclick="testErrorCode()">Test Error Code</button>
            <button onclick="testLosViableFalse()">Test LOS Not Viable</button>
            <button onclick="testNoViableKits()">Test No Viable Kits</button>
            <button onclick="testNewFormat()">Test New Format</button>
        </div>
        
        <div id="recommendation-block" style="display: none;">
            <div class="recommendation-container">
                <div id="recommendation-loading" class="recommendation-loading">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <p>Generando recomendaciones de kits...</p>
                    </div>
                </div>
                
                <div id="recommendation-content" class="recommendation-content" style="display: none;">
                    <!-- Content will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Test data
        const successData = [
            {
                "output": {
                    "viable_kits": [
                        {
                            "name": "KIT 3 - opción 1",
                            "radio": "Cambium 4600C",
                            "antenna": "Antena Txpro 30 dbi",
                            "frequency_band": "5.7 - 7.1",
                            "max_throughput": "2000",
                            "transmit_power": "30",
                            "antenna_gain": "5.1 GHz: 29 dBi\n5.1 - 5.9 GHz: 30 dBi\n6 - 7.1 GHz: 31 dBi",
                            "link_margin": "26.06",
                            "cost": "1940"
                        }
                    ],
                    "high_reliability_recommendation": "KIT 3 - opción 1",
                    "best_value_recommendation": "KIT 3 - opción 1",
                    "aigent_id": "AIG-20250713-112134-73O6X",
                    "error_code": null,
                    "error_explanation": null,
                    "los_viable": true
                }
            }
        ];

        const errorCodeData = [
            {
                "output": {
                    "viable_kits": [],
                    "high_reliability_recommendation": null,
                    "best_value_recommendation": null,
                    "aigent_id": "AIG-20250713-112134-73O6X",
                    "error_code": "E001",
                    "error_explanation": "No se encontraron kits compatibles para la distancia especificada",
                    "los_viable": true
                }
            }
        ];

        const losViableFalseData = [
            {
                "output": {
                    "viable_kits": [],
                    "high_reliability_recommendation": null,
                    "best_value_recommendation": null,
                    "aigent_id": "AIG-20250713-112134-73O6X",
                    "error_code": null,
                    "error_explanation": null,
                    "los_viable": false
                }
            }
        ];

        const noViableKitsData = [
            {
                "output": {
                    "viable_kits": [],
                    "high_reliability_recommendation": null,
                    "best_value_recommendation": null,
                    "aigent_id": "AIG-20250713-112134-73O6X",
                    "error_code": null,
                    "error_explanation": null,
                    "los_viable": true
                }
            }
        ];

        // Function to extract and validate kit recommendation data from various response formats
        function extractKitRecommendationData(responseData) {
            console.log('Extracting kit recommendation data from:', responseData);
            
            let recommendationData = null;
            let errorMessage = null;
            
            // Check if response has "0" key with output property (new format)
            if (responseData["0"] && responseData["0"].output) {
                recommendationData = responseData["0"].output;
            }
            // Check if response has output property (direct format)
            else if (responseData.output) {
                recommendationData = responseData.output;
            }
            // Check if response is an array with output property (array format)
            else if (Array.isArray(responseData) && responseData.length > 0 && responseData[0].output) {
                recommendationData = responseData[0].output;
            }
            // Check if response has the structure directly
            else if (responseData.viable_kits || responseData.high_reliability_recommendation || responseData.best_value_recommendation) {
                recommendationData = responseData;
            }
            
            // If we found recommendation data, check for errors
            if (recommendationData) {
                // Check for error_code and error_explanation
                if (recommendationData.error_code && recommendationData.error_code !== null) {
                    errorMessage = `Error ${recommendationData.error_code}: ${recommendationData.error_explanation || 'Error desconocido'}`;
                }
                
                // Check for los_viable status
                if (recommendationData.los_viable === false) {
                    errorMessage = 'No hay línea de vista viable para esta ubicación.';
                }
                
                // Additional validation: check if we have viable kits
                if (!recommendationData.viable_kits || !Array.isArray(recommendationData.viable_kits) || recommendationData.viable_kits.length === 0) {
                    if (!errorMessage) {
                        errorMessage = 'No se encontraron kits viables para esta ubicación.';
                    }
                }
            }
            
            return {
                data: recommendationData,
                error: errorMessage
            };
        }

        // Function to handle different types of errors from kit recommendations
        function handleKitRecommendationError(errorMessage, section = 'recommendations') {
            console.error('Kit recommendation error:', errorMessage);
            
            // Show recommendation block but with error state
            const recommendationBlock = document.getElementById('recommendation-block');
            if (recommendationBlock) {
                recommendationBlock.style.display = 'block';
            }
            
            // Hide loading, show error content
            const recommendationLoading = document.getElementById('recommendation-loading');
            const recommendationContent = document.getElementById('recommendation-content');
            
            if (recommendationLoading) {
                recommendationLoading.style.display = 'none';
            }
            if (recommendationContent) {
                recommendationContent.style.display = 'block';
                recommendationContent.innerHTML = `
                    <div class="error-message">
                        <h3>Error en las Recomendaciones</h3>
                        <p>${errorMessage}</p>
                        <button onclick="location.reload()">
                            Reintentar
                        </button>
                    </div>
                `;
            }
        }

        // Function to display kit recommendations
        function displayKitRecommendations(recommendationData) {
            console.log('Displaying kit recommendations:', recommendationData);
            
            // Show the recommendation block
            const recommendationBlock = document.getElementById('recommendation-block');
            if (recommendationBlock) {
                recommendationBlock.style.display = 'block';
            }
            
            // Hide loading, show content
            const recommendationLoading = document.getElementById('recommendation-loading');
            const recommendationContent = document.getElementById('recommendation-content');
            
            if (recommendationLoading) {
                recommendationLoading.style.display = 'none';
            }
            if (recommendationContent) {
                recommendationContent.style.display = 'block';
                recommendationContent.innerHTML = `
                    <h3>Recomendaciones Exitosas</h3>
                    <p>Se encontraron ${recommendationData.viable_kits.length} kits viables.</p>
                    <div class="kits-grid">
                        ${recommendationData.viable_kits.map(kit => `
                            <div class="kit-card">
                                <h4>${kit.name}</h4>
                                <p><strong>Radio:</strong> ${kit.radio}</p>
                                <p><strong>Antena:</strong> ${kit.antenna}</p>
                                <p><strong>Costo:</strong> $${kit.cost}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        // Test functions
        function testSuccessCase() {
            console.log('Testing success case...');
            const { data, error } = extractKitRecommendationData(successData);
            if (error) {
                handleKitRecommendationError(error);
            } else if (data) {
                displayKitRecommendations(data);
            }
        }

        function testErrorCode() {
            console.log('Testing error code case...');
            const { data, error } = extractKitRecommendationData(errorCodeData);
            if (error) {
                handleKitRecommendationError(error);
            } else if (data) {
                displayKitRecommendations(data);
            }
        }

        function testLosViableFalse() {
            console.log('Testing LOS not viable case...');
            const { data, error } = extractKitRecommendationData(losViableFalseData);
            if (error) {
                handleKitRecommendationError(error);
            } else if (data) {
                displayKitRecommendations(data);
            }
        }

        function testNoViableKits() {
            console.log('Testing no viable kits case...');
            const { data, error } = extractKitRecommendationData(noViableKitsData);
            if (error) {
                handleKitRecommendationError(error);
            } else if (data) {
                displayKitRecommendations(data);
            }
        }

        function testNewFormat() {
            console.log('Testing new format...');
            const newFormatData = {
                "0": {
                    "output": {
                        "viable_kits": [
                            {
                                "name": "KIT 3 - opción 1",
                                "radio": "Cambium 4600C",
                                "antenna": "Antena Txpro 30 dbi",
                                "frequency_band": "5.7 - 7.1",
                                "max_throughput": "2000",
                                "transmit_power": "30",
                                "antenna_gain": "5.1 GHz: 29 dBi\n5.1 - 5.9 GHz: 30 dBi\n6 - 7.1 GHz: 31 dBi",
                                "link_margin": "26.06",
                                "cost": "1940"
                            }
                        ],
                        "high_reliability_recommendation": "KIT 3 - opción 1",
                        "best_value_recommendation": "KIT 3 - opción 1",
                        "aigent_id": "AIG-20250713-112134-73O6X",
                        "error_code": null,
                        "error_explanation": null,
                        "los_viable": true
                    }
                }
            };
            
            const { data, error } = extractKitRecommendationData(newFormatData);
            if (error) {
                handleKitRecommendationError(error);
            } else if (data) {
                displayKitRecommendations(data);
            }
        }
    </script>

    <style>
        .test-section {
            margin: 2rem 0;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }
        
        .test-section button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            margin: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .test-section button:hover {
            background: #45a049;
        }
    </style>
</body>
</html> 