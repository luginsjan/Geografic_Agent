<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeout Handling Test - Geografic Agent</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #ffffff;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        .test-button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #45a049;
        }
        .test-button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.info {
            background: #2196F3;
            color: white;
        }
        .status.success {
            background: #4CAF50;
            color: white;
        }
        .status.error {
            background: #f44336;
            color: white;
        }
        .status.warning {
            background: #ff9800;
            color: white;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .timeout-test {
            background: #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Timeout Handling Test</h1>
    <p>This page tests the timeout handling improvements for the Geografic Agent application.</p>

    <div class="test-section">
        <h2>Test Configuration</h2>
        <div class="timeout-test">
            <strong>API Proxy Timeout:</strong> 28 seconds<br>
            <strong>Frontend Timeout:</strong> 30 seconds<br>
            <strong>Vercel Function Limit:</strong> 30 seconds<br>
            <strong>Progress Updates:</strong> Every 2 seconds
        </div>
    </div>

    <div class="test-section">
        <h2>Test SOP Selection with Timeout</h2>
        <p>This test simulates a SOP selection request that might take a long time to complete.</p>
        
        <button class="test-button" onclick="testSOPSelection()">Test SOP Selection</button>
        <button class="test-button" onclick="testSOPSelectionWithTimeout()">Test with Short Timeout (5s)</button>
        <button class="test-button" onclick="clearLog()">Clear Log</button>
        
        <div id="status" class="status info" style="display: none;"></div>
        <div id="log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>Test Progress Indicator</h2>
        <p>This test shows how the progress indicator works during long requests.</p>
        
        <button class="test-button" onclick="testProgressIndicator()">Test Progress Indicator</button>
        <button class="test-button" onclick="testProgressWithTimeout()">Test Progress with Timeout</button>
        
        <div id="progress-status" class="status info" style="display: none;"></div>
    </div>

    <script>
        // Helper function to make fetch requests with timeout (copied from main script)
        async function fetchWithTimeout(url, options = {}, timeoutMs = 30000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
            
            // Start progress indicator for long requests
            let progressInterval;
            if (timeoutMs > 10000) { // Only show progress for requests longer than 10 seconds
                let elapsed = 0;
                progressInterval = setInterval(() => {
                    elapsed += 2;
                    const progress = Math.min((elapsed / (timeoutMs / 1000)) * 100, 95); // Cap at 95% to show it's still working
                    updateStatus(`Procesando... (${Math.round(progress)}%)`, 'info');
                }, 2000); // Update every 2 seconds
            }
            
            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                if (progressInterval) {
                    clearInterval(progressInterval);
                }
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                if (progressInterval) {
                    clearInterval(progressInterval);
                }
                if (error.name === 'AbortError') {
                    throw new Error(`Request timed out after ${timeoutMs / 1000} seconds`);
                }
                throw error;
            }
        }

        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
            statusElement.style.display = 'block';
            log(`STATUS: ${message}`);
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
            document.getElementById('status').style.display = 'none';
        }

        async function testSOPSelection() {
            log('Starting SOP Selection test...');
            updateStatus('Testing SOP Selection with 30-second timeout...', 'info');
            
            const testData = {
                selectedResultId: 'SOP-00001',
                completeSopData: {
                    SOP: 'SOP-00001',
                    Plaza: 'Test Plaza',
                    distance_km: 5.2,
                    lineOfSight: {
                        hasLineOfSight: true,
                        totalDistanceKm: 5.2
                    }
                },
                bandwidth: '100',
                AigentID: 'TEST-' + Date.now()
            };

            try {
                const response = await fetchWithTimeout('/api/get-SOP-selection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                }, 30000);

                if (!response.ok) {
                    throw new Error(`Server responded with error: ${response.status} ${response.statusText}`);
                }

                const responseData = await response.json();
                log('SOP Selection successful!');
                log('Response data: ' + JSON.stringify(responseData, null, 2));
                updateStatus('SOP Selection completed successfully!', 'success');

            } catch (error) {
                log('SOP Selection error: ' + error.message);
                updateStatus('SOP Selection failed: ' + error.message, 'error');
            }
        }

        async function testSOPSelectionWithTimeout() {
            log('Starting SOP Selection test with short timeout...');
            updateStatus('Testing SOP Selection with 5-second timeout...', 'warning');
            
            const testData = {
                selectedResultId: 'SOP-00001',
                completeSopData: {
                    SOP: 'SOP-00001',
                    Plaza: 'Test Plaza',
                    distance_km: 5.2,
                    lineOfSight: {
                        hasLineOfSight: true,
                        totalDistanceKm: 5.2
                    }
                },
                bandwidth: '100',
                AigentID: 'TEST-' + Date.now()
            };

            try {
                const response = await fetchWithTimeout('/api/get-SOP-selection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                }, 5000); // 5 second timeout

                if (!response.ok) {
                    throw new Error(`Server responded with error: ${response.status} ${response.statusText}`);
                }

                const responseData = await response.json();
                log('SOP Selection successful (unexpected with short timeout)!');
                updateStatus('SOP Selection completed (unexpected)!', 'success');

            } catch (error) {
                log('SOP Selection timeout test result: ' + error.message);
                if (error.message.includes('timed out')) {
                    updateStatus('Timeout test passed - request correctly timed out', 'success');
                } else {
                    updateStatus('Unexpected error: ' + error.message, 'error');
                }
            }
        }

        async function testProgressIndicator() {
            log('Testing progress indicator...');
            updateStatus('Testing progress indicator with 15-second request...', 'info');
            
            // Simulate a long-running request
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 10;
                if (progress <= 90) {
                    updateStatus(`Simulated progress: ${progress}%`, 'info');
                }
            }, 1500);

            // Simulate the actual request
            setTimeout(() => {
                clearInterval(progressInterval);
                updateStatus('Progress indicator test completed!', 'success');
                log('Progress indicator test completed successfully');
            }, 15000);
        }

        async function testProgressWithTimeout() {
            log('Testing progress indicator with timeout...');
            updateStatus('Testing progress indicator with 8-second timeout...', 'warning');
            
            // Simulate a long-running request that will timeout
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 10;
                if (progress <= 90) {
                    updateStatus(`Simulated progress: ${progress}%`, 'info');
                }
            }, 1000);

            // Simulate timeout
            setTimeout(() => {
                clearInterval(progressInterval);
                updateStatus('Progress indicator timeout test completed!', 'error');
                log('Progress indicator timeout test completed');
            }, 8000);
        }

        // Initialize
        log('Timeout handling test page loaded');
        log('Ready to test timeout improvements');
    </script>
</body>
</html> 